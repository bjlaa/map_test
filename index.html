<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Wigot</title>
    <link rel="stylesheet" href="./css/styles.css">
    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <!-- Fontawesome -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
    <!-- LeafletJs -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.4/dist/leaflet.css" integrity="sha512-puBpdR0798OZvTTbP4A8Ix/l+A4dHDD0DGqYW6RQ+9jxkRFclaxxQb/SJAWZfWAkuyeQUytO7+7N4QKrDh+drA==" crossorigin=""/>
    <!-- Make sure you put this AFTER Leaflet's CSS -->
    <script src="https://unpkg.com/leaflet@1.3.4/dist/leaflet.js" integrity="sha512-nMMmRyTVoLYqjP9hrbed9S+FzjZHW5gY1TWCHA5ckwXZBadntCNs8kEqAWdrb9O7rxbCaA4lKTIWjDXZxflOcA==" crossorigin=""></script>
    <!-- MapBox -->
    <script src='https://api.mapbox.com/mapbox-gl-js/v0.50.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v0.50.0/mapbox-gl.css' rel='stylesheet' />

    <!-- Firebase main script -->
    <script src="https://www.gstatic.com/firebasejs/5.5.6/firebase-app.js"></script>
    <!-- Add additional Firebase services that you want to use -->
    <script src="https://www.gstatic.com/firebasejs/5.5.6/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.5.6/firebase-firestore.js"></script>
    <!-- Firebase UI: interface for authentication -->
    <script src="https://cdn.firebase.com/libs/firebaseui/3.4.1/firebaseui.js"></script>
    <link type="text/css" rel="stylesheet" href="https://cdn.firebase.com/libs/firebaseui/3.4.1/firebaseui.css" />
  </head>

  <body>
    <div id='container'>
      <div ref="modal" class="modalContainer" id="modal">
        <div class="background"></div>
        <div id="modalWigot" class="modalWigot">

        </div>
      </div>
        <div class="col-md-9">
            <!--La carte est ici</h4-->
            <div class="searchBar">
                <input type="text" class="searchInput form-control" v-model="inputPin" ref="modif" placeholder="Entre un Pin">
                <button type="button" class="searchButton btn btn-primary" @click="add()">Ajouter</button>
            </div>
            <i class='icon-spinner icon-spin icon-large'></i>
            <div ref="map" id='map' class="map" style="height: 800px;" @click="ajouterPin()"></div>  
        </div>
        <div class="col-md-3">
            <aside class="sidebar">
                <div>
                    <div class="card">
                        <h3 class="card-header">Meilleur Pin</h3>
                    <div class="card-body">
                        <p>Le pin #1 est...</p>
                    </div>
                    </div>
                </div>
                <div>
                    <div class="card">
                    <div class="card-header">
                        <h4>Pins ajoutés :</h4>
                    </div>
                    <div class="card-body">
                        <table>
                            <tbody>
                                <tr v-for="(pin, index) in pins">
                                    <td>{{ pin.nom }}</td>
                                    <td>{{ pin.score }}</td>
                                    <td><button type="button">Like</button>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    </div>
                </div>
            </aside>
        </div>
    </div>
      
    <script src="https://unpkg.com/vue@2.0.3/dist/vue.js"></script>
 
    <script>
      var SETTINGS = {
        isAuthEnabled: false
      }

      var signupComponent = `
        <div id="signupComponent" class="loginComponent">
          <h1 class="title">Welcome to Wigot!</h1>
          <div class="title2">Sign up to start creating your event:</div>
          <div id="firebaseui-auth-container"></div>
          <div class="alreadySignedup">
            <div class="alreadySignedupText">Already have an account?</div>
            <button onclick="vm.showLogin()">Login in</button>
          </div>
        </div>
      `
      var loginComponent = `
        <div id="loginComponent" class="loginComponent">
          <h1 class="title">Welcome back on Wigot!</h1>
          <div class="title2">Log in to access your last event:</div>
          <div id="firebaseui-auth-container"></div>
          <div class="noAccount">
            <div class="noAccountText">Need an account?</div>
            <button onclick="vm.showSignup()">Sign up</button>
          </div>
        </div>
      `
      var createEventComponent = `
        <div class="createEvent">
          <h4>Create an event:</h4>
          <h5 class="modalTitle">Name your event:</h5>
          <input class="searchInput form-control" type="text">
          <h5 class="guestList">Invite your friends/family members:</h5>
          <input class="searchInput form-control" type="text">
          <button class="btn btn-primary" @click="createEvent()">Create event</button>
          <button class="btn btn-primary" @click="toggleModal()">Close modal</button>
        </div>
      `

      /*
      * FirebaseUI config.
      */ 
      var uiConfig = {
        signInSuccessUrl: false,
        signInOptions: [
          // Leave the lines as is for the providers you want to offer your users.
          firebase.auth.GoogleAuthProvider.PROVIDER_ID,
          firebase.auth.FacebookAuthProvider.PROVIDER_ID,
          firebase.auth.TwitterAuthProvider.PROVIDER_ID,
        ],
        // tosUrl and privacyPolicyUrl accept either url string or a callback
        // function.
        // Terms of service url/callback.
        tosUrl: '<your-tos-url>',
        // Privacy policy url/callback.
        privacyPolicyUrl: function() {
          window.location.assign('<your-privacy-policy-url>');
        },
        // Callback
        callbacks: {
          signInSuccessWithAuthResult: function(currentUser, credential, redirectUrl) {
            console.log('Successfully signed in', currentUser, credential, redirectUrl);
            vm.saveUser(currentUser);
          }
        }
      };
      /*
      * Firebase Auth UI
      */
      var authUI = false;

      /*
        VUEJS 
      */
      var vm = new window.Vue({
        el: '#container',
        data: {
          eventTitle: '',
          pins: [
            { nom: "Le Mazet", score: 0 }
          ],
          map: null,
          tileLayer: null,
          inputPin: '',
          localisation: '',
          // We'll use this variable to display a discreet modal inviting
          // the user to try and give his location again
          isMissingLocation: false
        },
        mounted() {
          this.initMap();
          this.initFirebase();
        },
        methods: {
          /*
          * Initialize Firebase
          */
          initFirebase() {
            var config = {
              apiKey: "AIzaSyA3t1HqYqWLx62jVb8mc1ZuQ_l1pm6FBxI",
              authDomain: "wigot-220414.firebaseapp.com",
              databaseURL: "https://wigot-220414.firebaseio.com",
              projectId: "wigot-220414",
              storageBucket: "wigot-220414.appspot.com",
              messagingSenderId: "1057857701694"
            };
            var self = this;
            firebase.initializeApp(config);
            
            if (SETTINGS.isAuthEnabled) {
              this.startAuthentication();
            }
          },

          /*
          * Start authentication
          */
          startAuthentication() {
            var self = this;
            firebase.auth().onAuthStateChanged(function(user) {
              if (user) {
                console.log('User already connected');
              } else {
                self.showSignup();
              }
            })
          },

          /*
          * Login, Signup
          */
          showSignup() {
            document.getElementById('modalWigot').innerHTML = signupComponent;
            this.toggleModal(true);
            // Initialize the FirebaseUI Widget using Firebase.
            if (!authUI) {
              authUI = new firebaseui.auth.AuthUI(firebase.auth());
            }
            // The start method will wait until the DOM is loaded.
            authUI.start('#firebaseui-auth-container', uiConfig);
          },

          showLogin() {
            document.getElementById('modalWigot').innerHTML = loginComponent;
            this.toggleModal(true);
            // Initialize the FirebaseUI Widget using Firebase.
            if (!authUI) {
              authUI = new firebaseui.auth.AuthUI(firebase.auth());
            }
            // The start method will wait until the DOM is loaded.
            authUI.start('#firebaseui-auth-container', uiConfig);
          },

          /*
          * Get current position - called by body.onload
          */
          getLocation() {
            var self = this;
            if ('geolocation' in navigator) {
              navigator.geolocation.getCurrentPosition(
                // success callback: the user has accepted to give his location
                function (position) {
                  console.log('SUCCESS in getLocation(): position ===', position);
                  self.initMap({ lat: position.coords.latitude, long: position.coords.longitude });
                },
                // error callback: the user refused to give his location
                function () {
                  self.initMap();
                  self.isMissingLocation = true;
                },
              );
            } else {
              console.log('ERROR in initApp(): geolocation is not available on this browser.');
            }
          },
          initMap(coords) {
            // If we have been able to get the coordinates of the user 
            // we center the map on his location
            if (coords) {
              this.map = L.map('map').setView([coords.lat, coords.long], 15);
            } else {
              this.map = L.map('map').setView([48.53, 2.14], 15);
            }
            
            this.tileLayer = L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}',
            {
            maxZoom: 19,
            id: 'mapbox.streets',
            accessToken: 'pk.eyJ1IjoiYmpsYWEiLCJhIjoiY2pubzRmYm1iMGI5czNycTFsYTJpZng5biJ9.hbgbuJ24OKVcx4xELavpoQ',
            attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="https://www.mapbox.com/">Mapbox</a>'
            }).addTo(this.map);

            // Add the mouse click event listener
            // Need to pass this inside a function === SCOPE ISSUE
            // use the trick below: store this in a variable (usually "self")
            var self = this;
            var w = window;
            this.map.on('click', function(e) {
              // Get the coordinates from Leaflet
              var latlng = self.map.mouseEventToLatLng(e.originalEvent);
              console.log(latlng.lat + ', ' + latlng.lng);

              self.addPin(latlng.lat, latlng.lng)
            });
          },
          centerMap(coords) {
            L.map('map').setView([coords.lat, coords.long], 15);
          },
          // Handles creating the event
          createEvent() {
            console.log('Create the event!');
            this.toggleModal();
          },

          add: function () {
            this.pins.push({ nom: this.inputPin, score: 0 });
            this.inputPin = '';
          },

          addPin: function (lat, long) {
            var newMarker = new L.marker([lat, long]).addTo(this.map);
          },

          toggleModal(value) {
            if (value) {
              this.$refs.modal.classList.add('showModal');
            } else {
              this.$refs.modal.classList.toggle('showModal');
            }
          }
        }
      });
    </script> 
  </body>
</html>